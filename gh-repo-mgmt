#!/usr/bin/env bash

# shellcheck shell=bash

######################################################################
#<
#
# Function: p6_usage()
#
#  Args:
#
#  Environment:	 EOF LC_ALL NAME OPTIND RULE WHAT
#>
######################################################################
p6_usage() {
  local rc="${1:-0}"
  local msg="${2:-}"

  if [ -n "$msg" ]; then
    echo >&2 "$msg"
  fi
  cat <<EOF
Usage:
  gh-repo-mgmt [options] <cmd> [<args>...]

Commands:
  show <name>                      Show a repository setup
  update <name> <what>=<value>     Update a repository setup
  update-topics <name> <topic>...  Update repository topics
  clone-settings <src> <dest>      Copy settings from one repo to another

Options:
  -h                             Show this help message

Examples:
  gh-repo-mgmt show Gollucci/gh-repo-mgmt
  gh-repo-mgmt update Gollucci/gh-repo-mgmt has_issues=true has_wiki=false
  gh-repo-mgmt update-topics Gollucci/gh-repo-mgmt devops cli tool
  gh-repo-mgmt clone-settings p6m7g8/source-repo p6m7g8/target-repo
EOF
  exit "$rc"
}


######################################################################
#<
#
# Function: p6main()
#
#  Args:
#>
######################################################################
p6main() {
  shift 0

  # sanitize env
  LC_ALL=C

  # parse options
  local flag
  while getopts "h" flag; do
    case $flag in
    h) p6_usage 0 "help" ;;
    *) p6_usage 1 "invalid flag" ;;
    esac
  done
  shift $((OPTIND - 1))

  # grab command
  local cmd="$1"
  shift 1

  # security 101: only allow valid commands
  # normalize command names (support both hyphen and underscore variants)
  case $cmd in
  help) p6_usage ;;
  show) ;;
  update) ;;
  update-topics) cmd="update_topics" ;;
  update_topics) ;;
  clone-settings) cmd="clone_settings" ;;
  clone_settings) ;;
  *) p6_usage 1 "invalid cmd" ;;
  esac

  # exit if any cli errors w/ >0 return code
  # the commands can still disable locally if needed
  set -e
  p6_cmd_"${cmd}" "$@"
  set +e

  return 0
}

_gh() {

  gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" "$@"
}

######################################################################
#<
#
# Function: p6_cmd_show(name)
#
#  Args:
#	name -
#
#  Environment:	 GET
#>
######################################################################
p6_cmd_show() {

  _gh --method GET repos/:owner/:repo
}

######################################################################
#<
#
# Function: p6_cmd_update(name, key=value ...)
#
#  Args:
#	name - repository in owner/repo form
#	key=value ... - one or more key=value pairs to set
#
#  Environment:	 PUT PARAMS
#>
######################################################################
p6_cmd_update() {
  local name="$1"
  shift 1

  if [ -z "$name" ] || [ $# -eq 0 ]; then
    p6_usage 1 "Usage: gh-repo-mgmt update <owner>/<repo> <key>=<value>..."
  fi

  local owner repo
  owner="${name%%/*}"
  repo="${name##*/}"

  local -a data
  local pair key value
  for pair in "$@"; do
    key="${pair%%=*}"
    value="${pair#*=}"

    if [[ "$value" =~ ^(true|false|[0-9]+)$ ]]; then
      data+=("\"$key\":$value")
    else
      data+=("\"$key\":\"$value\"")
    fi
  done

  local payload="{${data[*]// /,}}"

  echo "Updating $owner/$repo with: $payload" >&2

  _gh --method PATCH "repos/${owner}/${repo}" -f data="$payload"
}

######################################################################
#<
#
# Function: p6_cmd_update_topics(name, topics...)
#
#  Args:
#	name - repository in owner/repo form
#	topics... - space-separated list of topics
#
#>
######################################################################
p6_cmd_update_topics() {
  local name="$1"
  shift 1

  local owner="${name%%/*}"
  local repo="${name##*/}"

  local topics_json
  topics_json=$(printf '"%s",' "$@")
  topics_json="[${topics_json%,}]"

  local payload="{\"names\":$topics_json}"

  echo "Updating topics for $owner/$repo -> $payload" >&2
  _gh --method PUT "repos/${owner}/${repo}/topics" --input <(echo "$payload")
}

######################################################################
#<
#
# Function: p6_cmd_clone_settings(source, target)
#
#  Args:
#	source - source repository in owner/repo form
#	target - target repository in owner/repo form
#
#>
######################################################################
p6_cmd_clone_settings() {
  local source="$1"
  local target="$2"

  if [ -z "$source" ] || [ -z "$target" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt clone-settings <source-owner/repo> <target-owner/repo>"
  fi

  local src_owner="${source%%/*}"
  local src_repo="${source##*/}"
  local tgt_owner="${target%%/*}"
  local tgt_repo="${target##*/}"

  echo "Fetching settings from $src_owner/$src_repo..." >&2

  # Get source repo settings
  local src_data
  src_data=$(_gh --method GET "repos/${src_owner}/${src_repo}")

  # Extract settings we want to copy
  local has_issues has_projects has_wiki has_downloads has_discussions
  local allow_squash_merge allow_merge_commit allow_rebase_merge
  local delete_branch_on_merge allow_auto_merge

  has_issues=$(echo "$src_data" | grep -o '"has_issues":[^,}]*' | cut -d: -f2)
  has_projects=$(echo "$src_data" | grep -o '"has_projects":[^,}]*' | cut -d: -f2)
  has_wiki=$(echo "$src_data" | grep -o '"has_wiki":[^,}]*' | cut -d: -f2)
  has_downloads=$(echo "$src_data" | grep -o '"has_downloads":[^,}]*' | cut -d: -f2)
  has_discussions=$(echo "$src_data" | grep -o '"has_discussions":[^,}]*' | cut -d: -f2)
  allow_squash_merge=$(echo "$src_data" | grep -o '"allow_squash_merge":[^,}]*' | cut -d: -f2)
  allow_merge_commit=$(echo "$src_data" | grep -o '"allow_merge_commit":[^,}]*' | cut -d: -f2)
  allow_rebase_merge=$(echo "$src_data" | grep -o '"allow_rebase_merge":[^,}]*' | cut -d: -f2)
  delete_branch_on_merge=$(echo "$src_data" | grep -o '"delete_branch_on_merge":[^,}]*' | cut -d: -f2)
  allow_auto_merge=$(echo "$src_data" | grep -o '"allow_auto_merge":[^,}]*' | cut -d: -f2)

  # Build payload for target repo
  local payload="{"
  payload+="\"has_issues\":$has_issues,"
  payload+="\"has_projects\":$has_projects,"
  payload+="\"has_wiki\":$has_wiki,"
  payload+="\"has_downloads\":$has_downloads,"
  payload+="\"has_discussions\":$has_discussions,"
  payload+="\"allow_squash_merge\":$allow_squash_merge,"
  payload+="\"allow_merge_commit\":$allow_merge_commit,"
  payload+="\"allow_rebase_merge\":$allow_rebase_merge,"
  payload+="\"delete_branch_on_merge\":$delete_branch_on_merge,"
  payload+="\"allow_auto_merge\":$allow_auto_merge"
  payload+="}"

  echo "Applying settings to $tgt_owner/$tgt_repo..." >&2
  echo "Settings: $payload" >&2

  _gh --method PATCH "repos/${tgt_owner}/${tgt_repo}" --input <(echo "$payload")

  # Copy topics
  echo "Copying topics..." >&2
  local topics
  topics=$(_gh --method GET "repos/${src_owner}/${src_repo}/topics")

  _gh --method PUT "repos/${tgt_owner}/${tgt_repo}/topics" --input <(echo "$topics")

  echo "Done! Settings cloned from $source to $target" >&2
}

p6main "$@"
