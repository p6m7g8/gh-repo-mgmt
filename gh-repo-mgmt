#!/usr/bin/env bash

# shellcheck shell=bash

######################################################################
#<
#
# Function: p6_usage()
#
#  Args:
#
#  Environment:	 EOF LC_ALL NAME OPTIND RULE WHAT
#>
######################################################################
p6_usage() {
  local rc="${1:-0}"
  local msg="${2:-}"

  if [ -n "$msg" ]; then
    echo >&2 "$msg"
  fi
  cat <<EOF
Usage:
  gh-repo-mgmt [options] <cmd> [<args>...]

Commands:
  create <name> [options]          Create a repository (idempotent)
  delete <name>                    Delete a repository (idempotent)
  rename <name> <new-name>         Rename a repository (idempotent)
  transfer <name> <new-owner>      Transfer repository ownership (idempotent)
  ensure <name> [options]          Ensure repository exists with settings (create or update)
  show [<name>]                    Show a repository setup (defaults to current repo)
  list <owner> [--type=<type>]     List repositories for a user/org
  update <name> <what>=<value>     Update a repository setup
  update-topics <name> <topic>...  Replace repository topics
  add-topic <name> <topic>...      Add topics to repository (keeps existing)

Options:
  -h                             Show this help message

Create/Ensure Options:
  --public                       Create as public repository (default)
  --private                      Create as private repository
  --description=<text>           Repository description
  --homepage=<url>               Repository homepage URL
  --disable-wiki                 Disable wiki
  --disable-issues               Disable issues
  --disable-projects             Disable projects
  --topics=<tag1,tag2,...>       Comma-separated repository topics (ensure only)

Examples:
  gh-repo-mgmt create p6m7g8/new-repo --private --description="My new repo"
  gh-repo-mgmt delete p6m7g8/old-repo
  gh-repo-mgmt rename p6m7g8/old-name new-name
  gh-repo-mgmt transfer p6m7g8/my-repo new-owner
  gh-repo-mgmt ensure p6m7g8/my-repo --private --description="Repo" --topics="tag1,tag2"
  gh-repo-mgmt show Gollucci/gh-repo-mgmt
  gh-repo-mgmt list p6m7g8
  gh-repo-mgmt list p6m7g8 --type=public
  gh-repo-mgmt update Gollucci/gh-repo-mgmt has_issues=true has_wiki=false
  gh-repo-mgmt update-topics Gollucci/gh-repo-mgmt devops cli tool
  gh-repo-mgmt add-topic Gollucci/gh-repo-mgmt new-topic
EOF
  exit "$rc"
}


######################################################################
#<
#
# Function: p6main()
#
#  Args:
#>
######################################################################
p6main() {
  shift 0

  # sanitize env
  LC_ALL=C

  # parse options
  local flag
  while getopts "h" flag; do
    case $flag in
    h) p6_usage 0 "help" ;;
    *) p6_usage 1 "invalid flag" ;;
    esac
  done
  shift $((OPTIND - 1))

  # grab command
  local cmd="$1"
  shift 1

  # security 101: only allow valid commands
  # normalize command names (support both hyphen and underscore variants)
  case $cmd in
  help) p6_usage ;;
  create) ;;
  delete) ;;
  rename) ;;
  transfer) ;;
  ensure) ;;
  show) ;;
  list) ;;
  update) ;;
  update-topics) cmd="update_topics" ;;
  update_topics) ;;
  add-topic) cmd="add_topic" ;;
  add_topic) ;;
  *) p6_usage 1 "invalid cmd" ;;
  esac

  # exit if any cli errors w/ >0 return code
  # the commands can still disable locally if needed
  set -e
  p6_cmd_"${cmd}" "$@"
  set +e

  return 0
}

_gh() {

  gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" "$@"
}

######################################################################
#<
#
# Function: p6_cmd_create(name, options...)
#
#  Args:
#	name - repository in owner/repo form
#	options - optional flags (--private, --public, --description=, etc.)
#
#  Environment:	 POST GET
#>
######################################################################
p6_cmd_create() {
  local name="$1"
  shift 1

  if [ -z "$name" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt create <owner>/<repo> [options]"
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  # Check if repository already exists (idempotent)
  if _gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -q "\"name\""; then
    echo "Repository $owner/$repo already exists (idempotent)" >&2
    _gh --method GET "repos/${owner}/${repo}" | grep -E '"name"|"private"|"description"'
    return 0
  fi

  # Parse options
  local visibility="public"
  local description=""
  local homepage=""
  local has_issues="true"
  local has_wiki="true"
  local has_projects="true"

  while [ $# -gt 0 ]; do
    case "$1" in
      --private)
        visibility="private"
        ;;
      --public)
        visibility="public"
        ;;
      --description=*)
        description="${1#--description=}"
        ;;
      --homepage=*)
        homepage="${1#--homepage=}"
        ;;
      --disable-wiki)
        has_wiki="false"
        ;;
      --disable-issues)
        has_issues="false"
        ;;
      --disable-projects)
        has_projects="false"
        ;;
      *)
        echo "Unknown option: $1" >&2
        p6_usage 1
        ;;
    esac
    shift
  done

  # Build payload
  local payload="{"
  payload+="\"name\":\"$repo\""
  payload+=",\"private\":$([ "$visibility" = "private" ] && echo "true" || echo "false")"
  payload+=",\"has_issues\":$has_issues"
  payload+=",\"has_wiki\":$has_wiki"
  payload+=",\"has_projects\":$has_projects"
  [ -n "$description" ] && payload+=",\"description\":\"$description\""
  [ -n "$homepage" ] && payload+=",\"homepage\":\"$homepage\""
  payload+="}"

  echo "Creating repository $owner/$repo with visibility=$visibility" >&2
  echo "Payload: $payload" >&2

  # Determine API endpoint (user vs org)
  if gh api "users/${owner}" 2>/dev/null | grep -q "\"type\":\"Organization\""; then
    _gh --method POST "orgs/${owner}/repos" --input <(echo "$payload")
  else
    _gh --method POST "user/repos" --input <(echo "$payload")
  fi
}

######################################################################
#<
#
# Function: p6_cmd_delete(name)
#
#  Args:
#	name - repository in owner/repo form
#
#  Environment:	 DELETE GET
#>
######################################################################
p6_cmd_delete() {
  local name="$1"

  if [ -z "$name" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt delete <owner>/<repo>"
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  # Check if repository exists (idempotent)
  if ! _gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -q "\"name\""; then
    echo "Repository $owner/$repo does not exist (idempotent - already deleted)" >&2
    return 0
  fi

  echo "Deleting repository $owner/$repo" >&2
  _gh --method DELETE "repos/${owner}/${repo}"

  echo "Repository $owner/$repo deleted successfully" >&2
}

######################################################################
#<
#
# Function: p6_cmd_rename(name, new_name)
#
#  Args:
#	name - repository in owner/repo form
#	new_name - new repository name (without owner)
#
#  Environment:	 PATCH GET
#>
######################################################################
p6_cmd_rename() {
  local name="$1"
  local new_name="$2"

  if [ -z "$name" ] || [ -z "$new_name" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt rename <owner>/<repo> <new-name>"
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  # Check if repository exists
  if ! _gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -q "\"name\""; then
    echo "Error: Repository $owner/$repo does not exist" >&2
    return 1
  fi

  # Check if already has the desired name (idempotent)
  local current_name
  current_name=$(_gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -o "\"name\":\"[^\"]*\"" | head -1 | cut -d'"' -f4)

  if [ "$current_name" = "$new_name" ]; then
    echo "Repository $owner/$repo already has name '$new_name' (idempotent)" >&2
    return 0
  fi

  # Check if target name already exists
  if _gh --method GET "repos/${owner}/${new_name}" 2>/dev/null | grep -q "\"name\""; then
    echo "Error: Repository $owner/$new_name already exists" >&2
    return 1
  fi

  echo "Renaming repository $owner/$repo to $new_name" >&2

  local payload="{\"name\":\"$new_name\"}"
  _gh --method PATCH "repos/${owner}/${repo}" --input <(echo "$payload")

  echo "Repository renamed successfully: $owner/$repo -> $owner/$new_name" >&2
}

######################################################################
#<
#
# Function: p6_cmd_transfer(name, new_owner)
#
#  Args:
#	name - repository in owner/repo form
#	new_owner - new owner (user or organization)
#
#  Environment:	 POST GET
#>
######################################################################
p6_cmd_transfer() {
  local name="$1"
  local new_owner="$2"

  if [ -z "$name" ] || [ -z "$new_owner" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt transfer <owner>/<repo> <new-owner>"
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  # Check if repository exists under current owner
  if ! _gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -q "\"name\""; then
    echo "Error: Repository $owner/$repo does not exist" >&2
    return 1
  fi

  # Check current owner (idempotent)
  local current_owner
  current_owner=$(_gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -o "\"owner\":{[^}]*\"login\":\"[^\"]*\"" | grep -o "\"login\":\"[^\"]*\"" | cut -d'"' -f4)

  if [ "$current_owner" = "$new_owner" ]; then
    echo "Repository $owner/$repo already owned by '$new_owner' (idempotent)" >&2
    return 0
  fi

  # Check if new owner exists
  if ! gh api "users/${new_owner}" 2>/dev/null | grep -q "\"login\""; then
    echo "Error: User or organization '$new_owner' does not exist" >&2
    return 1
  fi

  echo "Transferring repository $owner/$repo to $new_owner" >&2

  local payload="{\"new_owner\":\"$new_owner\"}"
  _gh --method POST "repos/${owner}/${repo}/transfer" --input <(echo "$payload")

  echo "Repository transferred successfully: $owner/$repo -> $new_owner/$repo" >&2
}

######################################################################
#<
#
# Function: p6_cmd_show(name)
#
#  Args:
#	name - repository in owner/repo form (optional, defaults to current repo)
#
#  Environment:	 GET
#>
######################################################################
p6_cmd_show() {
  local name="${1:-}"

  if [ -z "$name" ]; then
    # Use current repo context
    _gh --method GET repos/:owner/:repo
  else
    local owner="${name%%/*}"
    local repo="${name##*/}"
    _gh --method GET "repos/${owner}/${repo}"
  fi
}

######################################################################
#<
#
# Function: p6_cmd_list(owner, [--type=<type>])
#
#  Args:
#	owner - user or organization name
#	--type - filter by type: all, public, private, forks, sources (default: all)
#
#>
######################################################################
p6_cmd_list() {
  local owner="$1"
  shift 1

  if [ -z "$owner" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt list <owner> [--type=<type>]"
  fi

  local repo_type="all"
  local arg
  for arg in "$@"; do
    case "$arg" in
    --type=*) repo_type="${arg#--type=}" ;;
    *) p6_usage 1 "Unknown option: $arg" ;;
    esac
  done

  # Validate type
  case "$repo_type" in
  all | public | private | forks | sources) ;;
  *) p6_usage 1 "Invalid type: $repo_type. Must be: all, public, private, forks, sources" ;;
  esac

  _gh --method GET "users/${owner}/repos" -f type="$repo_type" -f per_page=100 --paginate
}

######################################################################
#<
#
# Function: p6_cmd_update(name, key=value ...)
#
#  Args:
#	name - repository in owner/repo form
#	key=value ... - one or more key=value pairs to set
#
#  Environment:	 PUT PARAMS
#>
######################################################################
p6_cmd_update() {
  local name="$1"
  shift 1

  if [ -z "$name" ] || [ $# -eq 0 ]; then
    p6_usage 1 "Usage: gh-repo-mgmt update <owner>/<repo> <key>=<value>..."
  fi

  local owner repo
  owner="${name%%/*}"
  repo="${name##*/}"

  local -a data
  local pair key value
  for pair in "$@"; do
    key="${pair%%=*}"
    value="${pair#*=}"

    if [[ "$value" =~ ^(true|false|[0-9]+)$ ]]; then
      data+=("\"$key\":$value")
    else
      data+=("\"$key\":\"$value\"")
    fi
  done

  local payload="{${data[*]// /,}}"

  echo "Updating $owner/$repo with: $payload" >&2

  _gh --method PATCH "repos/${owner}/${repo}" -f data="$payload"
}

######################################################################
#<
#
# Function: p6_cmd_update_topics(name, topics...)
#
#  Args:
#	name - repository in owner/repo form
#	topics... - space-separated list of topics
#
#>
######################################################################
p6_cmd_update_topics() {
  local name="$1"
  shift 1

  if [ -z "$name" ] || [ $# -eq 0 ]; then
    p6_usage 1 "Usage: gh-repo-mgmt update_topics <owner>/<repo> <topic>..."
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  local topics_json
  topics_json=$(printf '"%s",' "$@")
  topics_json="[${topics_json%,}]"

  local payload="{\"names\":$topics_json}"

  echo "Updating topics for $owner/$repo -> $payload" >&2
  _gh --method PUT "repos/${owner}/${repo}/topics" --input <(echo "$payload")
}

######################################################################
#<
#
# Function: p6_cmd_add_topic(name, topics...)
#
#  Args:
#	name - repository in owner/repo form
#	topics... - space-separated list of topics to add
#
#>
######################################################################
p6_cmd_add_topic() {
  local name="$1"
  shift 1

  if [ -z "$name" ] || [ $# -eq 0 ]; then
    p6_usage 1 "Usage: gh-repo-mgmt add-topic <owner>/<repo> <topic>..."
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  # Get current topics
  local current_topics
  current_topics=$(_gh --method GET "repos/${owner}/${repo}/topics" --jq '.names[]' 2>/dev/null || true)

  # Combine current and new topics, removing duplicates
  local -a all_topics
  local topic

  # Add current topics
  while IFS= read -r topic; do
    [ -n "$topic" ] && all_topics+=("$topic")
  done <<< "$current_topics"

  # Add new topics (skip if already exists)
  for topic in "$@"; do
    local exists=false
    local existing
    for existing in "${all_topics[@]}"; do
      if [ "$existing" = "$topic" ]; then
        exists=true
        break
      fi
    done
    if [ "$exists" = false ]; then
      all_topics+=("$topic")
    fi
  done

  # Build JSON payload
  local topics_json
  topics_json=$(printf '"%s",' "${all_topics[@]}")
  topics_json="[${topics_json%,}]"

  local payload="{\"names\":$topics_json}"

  echo "Adding topics to $owner/$repo -> $payload" >&2
  _gh --method PUT "repos/${owner}/${repo}/topics" --input <(echo "$payload")
}

p6main "$@"

######################################################################
#<
#
# Function: p6_cmd_ensure(name, options...)
#
#  Args:
#	name - repository in owner/repo form
#	options - optional flags (same as create, plus --topics)
#
#  Environment:	 POST GET PATCH PUT
#>
######################################################################
p6_cmd_ensure() {
  local name="$1"
  shift 1

  if [ -z "$name" ]; then
    p6_usage 1 "Usage: gh-repo-mgmt ensure <owner>/<repo> [options]"
  fi

  local owner="${name%%/*}"
  local repo="${name##*/}"

  # Parse options (same as create, plus --topics)
  local visibility="public"
  local description=""
  local homepage=""
  local has_issues="true"
  local has_wiki="true"
  local has_projects="true"
  local topics=""

  while [ $# -gt 0 ]; do
    case "$1" in
      --private)
        visibility="private"
        ;;
      --public)
        visibility="public"
        ;;
      --description=*)
        description="${1#--description=}"
        ;;
      --homepage=*)
        homepage="${1#--homepage=}"
        ;;
      --disable-wiki)
        has_wiki="false"
        ;;
      --disable-issues)
        has_issues="false"
        ;;
      --disable-projects)
        has_projects="false"
        ;;
      --topics=*)
        topics="${1#--topics=}"
        ;;
      *)
        echo "Unknown option: $1" >&2
        p6_usage 1
        ;;
    esac
    shift
  done

  # Check if repository exists
  if ! _gh --method GET "repos/${owner}/${repo}" 2>/dev/null | grep -q "\"name\""; then
    echo "Repository $owner/$repo does not exist, creating..." >&2

    # Build create payload
    local payload="{"
    payload+="\"name\":\"$repo\""
    payload+=",\"private\":$([ "$visibility" = "private" ] && echo "true" || echo "false")"
    payload+=",\"has_issues\":$has_issues"
    payload+=",\"has_wiki\":$has_wiki"
    payload+=",\"has_projects\":$has_projects"
    [ -n "$description" ] && payload+=",\"description\":\"$description\""
    [ -n "$homepage" ] && payload+=",\"homepage\":\"$homepage\""
    payload+="}"

    # Create repository
    if gh api "users/${owner}" 2>/dev/null | grep -q "\"type\":\"Organization\""; then
      _gh --method POST "orgs/${owner}/repos" --input <(echo "$payload")
    else
      _gh --method POST "user/repos" --input <(echo "$payload")
    fi

    # Set topics if provided
    if [ -n "$topics" ]; then
      echo "Setting topics: $topics" >&2
      IFS=',' read -ra topic_array <<< "$topics"
      local topics_json
      topics_json=$(printf '"%s",' "${topic_array[@]}")
      topics_json="[${topics_json%,}]"
      local topic_payload="{\"names\":$topics_json}"
      _gh --method PUT "repos/${owner}/${repo}/topics" --input <(echo "$topic_payload")
    fi

    echo "Repository $owner/$repo created successfully" >&2
  else
    echo "Repository $owner/$repo exists, updating settings..." >&2

    # Build update payload
    local payload="{"
    payload+="\"private\":$([ "$visibility" = "private" ] && echo "true" || echo "false")"
    payload+=",\"has_issues\":$has_issues"
    payload+=",\"has_wiki\":$has_wiki"
    payload+=",\"has_projects\":$has_projects"
    [ -n "$description" ] && payload+=",\"description\":\"$description\""
    [ -n "$homepage" ] && payload+=",\"homepage\":\"$homepage\""
    payload+="}"

    # Update repository settings
    _gh --method PATCH "repos/${owner}/${repo}" --input <(echo "$payload")

    # Update topics if provided
    if [ -n "$topics" ]; then
      echo "Updating topics: $topics" >&2
      IFS=',' read -ra topic_array <<< "$topics"
      local topics_json
      topics_json=$(printf '"%s",' "${topic_array[@]}")
      topics_json="[${topics_json%,}]"
      local topic_payload="{\"names\":$topics_json}"
      _gh --method PUT "repos/${owner}/${repo}/topics" --input <(echo "$topic_payload")
    fi

    echo "Repository $owner/$repo updated successfully" >&2
  fi
}
